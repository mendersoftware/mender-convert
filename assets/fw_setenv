#!/bin/bash
# Script to set U-Boot environment variables from input wrapper function to deal with
# This u boot for radax and mender 5.0.2.

# Check if we have input from pipe or redirection
if [ ! -t 0 ]; then
    # Read from stdin (pipe/redirect)
    input=$(cat)
else
    echo "Mender Uboot wrapper Usage: $0 < input_file"
    echo "   or: echo 'key=value' | $0"
    echo "   or: $0 <<< 'key=value'"
    exit 1
fi

# Process each line
echo "$input" | while IFS='=' read -r key value; do
    # Skip empty lines and lines starting with #
    [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]] && continue
    
    # Remove leading/trailing whitespace
    key=$(echo "$key" | xargs)
    value=$(echo "$value" | xargs)
    
    # Skip if key is empty (doesn't delete it)
    [[ -z "$key" ]] && continue
    
    # Set the with off path fw_setenv
    /root/fw_setenv "$key" "$value"
    
    # Check if command succeeded
    if [ $? -ne 0 ]; then
        echo "Error: Failed to set $key=$value" >&2
        exit 1
    fi
done
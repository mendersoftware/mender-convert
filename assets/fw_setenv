#!/bin/bash
# Script to set U-Boot environment variables from input wrapper function to deal with
# This u boot for radax and mender 5.0.2.

set_var() {
    local key="$1"
    local value="$2"
    
    # Set with off path fw_setenv
    /root/fw_setenv "$key" "$value"
    
    # Check if command succeeded
    if [ $? -ne 0 ]; then
        echo "Error: Failed to set $key=$value" >&2
        return 1
    fi
    return 0
}

# Check if we have command-line arguments
if [ $# -gt 0 ]; then
    # Process command-line arguments
    i=1
    while [ $i -le $# ]; do
        arg="${!i}"
        
        # Skip flags starting with - (ignore -s and -)
        if [[ "$arg" =~ ^- ]]; then
            ((i++))
            continue
        fi
        
        # Handle key=value format
        if [[ "$arg" =~ ^([^=]+)=(.*)$ ]]; then
            key="${BASH_REMATCH[1]}"
            value="${BASH_REMATCH[2]}"
            key=$(echo "$key" | xargs)
            value=$(echo "$value" | xargs)
            set_var "$key" "$value" || exit 1
            ((i++))
        # Handle "key value" format (two arguments)
        elif [ $((i + 1)) -le $# ]; then
            key="$arg"
            next_index=$((i + 1))
            value="${!next_index}"
            
            # Skip if next value is a flag
            if [[ "$value" =~ ^- ]]; then
                echo "Error: Missing value for key: $key" >&2
                exit 1
            fi
            
            key=$(echo "$key" | xargs)
            value=$(echo "$value" | xargs)
            set_var "$key" "$value" || exit 1
            ((i += 2))
        else
            echo "Error: Missing value for key: $arg" >&2
            exit 1
        fi
    done
fi

# Check if we have input from pipe or redirection (stdin)
if [ ! -t 0 ]; then
    # Read from stdin (pipe/redirect)
    input=$(cat)
    
    # Process each line
    echo "$input" | while IFS='=' read -r key value; do
        # Skip empty lines and lines starting with #
        [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]] && continue
        
        # Remove leading/trailing whitespace
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs)
        
        # Skip if key is empty (doesn't delete it)
        [[ -z "$key" ]] && continue
        
        # Set with off path fw_setenv
        /root/fw_setenv "$key" "$value"
        
        # Check if command succeeded
        if [ $? -ne 0 ]; then
            echo "Error: Failed to set $key=$value" >&2
            exit 1
        fi
    done
fi

# If no stdin and no arguments, show usage
if [ $# -eq 0 ] && [ -t 0 ]; then
    echo "Mender Uboot wrapper Usage:"
    echo "  $0 key value                  # Set single variable"
    echo "  $0 key1=value1 key2=value2   # Set multiple with = format"
    echo "  $0 key1 value1 key2 value2   # Set multiple with space format"
    echo "  $0 < input_file               # Read from file"
    echo "  echo 'key=value' | $0         # Read from pipe"
    echo "  $0 -s - <<EOF                 # Compatible with fw_setenv -s"
    echo "    key1=value1"
    echo "    key2=value2"
    echo "  EOF"
    exit 1
fi
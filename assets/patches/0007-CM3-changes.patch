From e6a3f26a1cf69a2f6be6d31184aa4c72b65af95d Mon Sep 17 00:00:00 2001
From: Ed Watson <edmundwatson@gmail.com>
Date: Thu, 9 Oct 2025 10:55:44 +0200
Subject: [PATCH] CM3 changes

Signed-off-by: Ed Watson <edmundwatson@gmail.com>
---
 Makefile                               | 2 +-
 configs/perfecta-cm3i-rk3568_defconfig | 4 ++++
 configs/rk3568_defconfig               | 2 ++
 fw_env.config                          | 2 ++
 include/config_mender_defines.h        | 6 +++---
 include/configs/rk3368_common.h        | 2 ++
 include/configs/rk3568_common.h        | 3 +++
 7 files changed, 17 insertions(+), 4 deletions(-)
 create mode 100644 fw_env.config

diff --git a/Makefile b/Makefile
index 1012b065ad..b8dce23e29 100644
--- a/Makefile
+++ b/Makefile
@@ -367,7 +367,7 @@ KBUILD_CPPFLAGS := -D__KERNEL__ -D__UBOOT__
 KBUILD_CFLAGS   := -Wall -Wstrict-prototypes \
 		   -Wno-format-security \
 		   -fno-builtin -ffreestanding
-KBUILD_CFLAGS	+= -fshort-wchar -Werror
+KBUILD_CFLAGS	+= -fshort-wchar 
 KBUILD_AFLAGS   := -D__ASSEMBLY__
 
 # Read UBOOTRELEASE from include/config/uboot.release (if it exists)
diff --git a/configs/perfecta-cm3i-rk3568_defconfig b/configs/perfecta-cm3i-rk3568_defconfig
index 3aa6736bcb..5586aaa9af 100644
--- a/configs/perfecta-cm3i-rk3568_defconfig
+++ b/configs/perfecta-cm3i-rk3568_defconfig
@@ -8,6 +8,8 @@ CONFIG_ROCKCHIP_RK3568=y
 CONFIG_ROCKCHIP_FIT_IMAGE=y
 CONFIG_ROCKCHIP_VENDOR_PARTITION=y
 CONFIG_ROCKCHIP_FIT_IMAGE_PACK=y
+CONFIG_BOOTCOUNT_ENV=y
+CONFIG_BOOTCOUNT_LIMIT=y
 CONFIG_ROCKCHIP_NEW_IDB=y
 CONFIG_ROCKCHIP_EMMC_IOMUX=y
 # CONFIG_ROCKCHIP_SET_SN is not set
@@ -229,3 +231,5 @@ CONFIG_AVB_LIBAVB_USER=y
 CONFIG_RK_AVB_LIBAVB_USER=y
 CONFIG_OPTEE_CLIENT=y
 CONFIG_OPTEE_V2=y
+CONFIG_ENV_IS_IN_MMC=y
+CONFIG_ENV_OFFSET=0x400000
\ No newline at end of file
diff --git a/configs/rk3568_defconfig b/configs/rk3568_defconfig
index acd1fb1816..6f7321c825 100644
--- a/configs/rk3568_defconfig
+++ b/configs/rk3568_defconfig
@@ -224,3 +224,5 @@ CONFIG_RK_AVB_LIBAVB_USER=y
 CONFIG_OPTEE_CLIENT=y
 CONFIG_OPTEE_V2=y
 CONFIG_OPTEE_ALWAYS_USE_SECURITY_PARTITION=y
+CONFIG_BOOTCOUNT_LIMIT=y
+CONFIG_BOOTCOUNT_ENV=y
\ No newline at end of file
diff --git a/fw_env.config b/fw_env.config
new file mode 100644
index 0000000000..b26745b4be
--- /dev/null
+++ b/fw_env.config
@@ -0,0 +1,2 @@
+/dev/mmcblk0 0x400000 0x8000
+/dev/mmcblk0 0x800000 0x8000
diff --git a/include/config_mender_defines.h b/include/config_mender_defines.h
index 7f4032ffae..6a3dad76ff 100644
--- a/include/config_mender_defines.h
+++ b/include/config_mender_defines.h
@@ -15,11 +15,11 @@
 #define MENDER_UBOOT_STORAGE_DEVICE 0
 
 /* BB variables. */
-#define MENDER_STORAGE_DEVICE_BASE "/dev/mmcblk0p"
+#define MENDER_STORAGE_DEVICE_BASE "/dev/mmcblk1p"
 #define MENDER_UBOOT_ENV_STORAGE_DEVICE_OFFSET_1 0x400000
 #define MENDER_UBOOT_ENV_STORAGE_DEVICE_OFFSET_2 0x800000
-#define MENDER_ROOTFS_PART_A_NAME "/dev/mmcblk0p2"
-#define MENDER_ROOTFS_PART_B_NAME "/dev/mmcblk0p3"
+#define MENDER_ROOTFS_PART_A_NAME "/dev/mmcblk1p2"
+#define MENDER_ROOTFS_PART_B_NAME "/dev/mmcblk1p3"
 
 /* For sanity checks. */
 #define MENDER_BOOTENV_SIZE 0x8000
diff --git a/include/configs/rk3368_common.h b/include/configs/rk3368_common.h
index 4a0f87a252..58dc8ed4bb 100644
--- a/include/configs/rk3368_common.h
+++ b/include/configs/rk3368_common.h
@@ -70,3 +70,5 @@
 #endif
 
 #endif
+
+
diff --git a/include/configs/rk3568_common.h b/include/configs/rk3568_common.h
index 4ea4e964ed..90349af52c 100644
--- a/include/configs/rk3568_common.h
+++ b/include/configs/rk3568_common.h
@@ -10,6 +10,9 @@
 #define CFG_CPUID_OFFSET		0xa
 
 #include "rockchip-common.h"
+#undef CONFIG_ENV_OFFSET
+#define CONFIG_BOOTCOUNT_ENV
+#define CONFIG_BOOTCOUNT_LIMIT
 
 #define CONFIG_SPL_FRAMEWORK
 #define CONFIG_SPL_TEXT_BASE		0x00000000
-- 
2.48.1


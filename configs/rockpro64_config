# Binaries generated with the following script:
#    https://downloads.mender.io/mender-convert/uboot/rockpro64/integration-scripts.tar.gz

# ROCKPro64 do not support GRUB bootloader integration, fallback to U-boot.
MENDER_GRUB_EFI_INTEGRATION=n

# We will write a modified bootloader
MENDER_COPY_BOOT_GAP=n



function platform_modify() {
    mkdir -p work/rockpro64

    run_and_log_cmd "sudo cp assets/idbloader.img  work/rockpro64"
    run_and_log_cmd "sudo cp assets/u-boot.itb work/rockpro64"
    run_and_log_cmd "sudo cp assets/fw_printenv work/rockpro64"
    run_and_log_cmd "sudo cp assets/fw_setenv work/rockpro64"
    run_and_log_cmd "sudo cp assets/fw_env.config work/rockpro64"

    run_and_log_cmd "sudo cp work/rockpro64/fw_env.config work/rootfs/etc/"
    run_and_log_cmd "sudo install -m 755 work/rockpro64/fw_printenv work/rootfs/usr/bin/fw_printenv"
    #fw_setenv wrapper
    run_and_log_cmd "sudo install -m 755 work/rockpro64/fw_setenv work/rootfs/usr/bin/fw_setenv"
    #Oringal fw_set outside of path
    run_and_log_cmd "sudo ln -fs /usr/bin/fw_printenv work/rootfs/root/fw_setenv"

    
    # It is not possible to resize rootfs part when using Mender. so disable
    # the service
    run_and_log_cmd "sudo touch work/rootfs/root/.no_rootfs_resize"
}

function platform_package() {
    log_info "Embedding bootloader in disk image"
    run_and_log_cmd "dd conv=notrunc,fsync if="work/rockpro64/idbloader.img" of=${img_path}  bs=512 seek=64"
    run_and_log_cmd "dd conv=notrunc,fsync if="work/rockpro64/u-boot.itb" of=${img_path}  bs=512 seek=16384"
    log_info "Setting up userspace"
}